name: "Node.js Security Scan - Dynamic"

on:
  workflow_dispatch:

jobs:
  node-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        
    - name: Install dependencies
      run: |
        set +e  # Don't exit on error
        if [ -f "package.json" ]; then
          if [ -f "package-lock.json" ]; then
            echo "Installing from lock file..."
            npm ci --no-audit --no-fund || echo "npm ci failed, trying npm install..."
            npm install --no-audit --no-fund || echo "npm install also failed"
          else
            echo "No lock file found, running npm install..."
            npm install --no-audit --no-fund || echo "npm install failed"
          fi
        else
          echo "No package.json found, creating dummy package.json"
          echo '{"name": "test-project", "version": "1.0.0", "scripts": {}}' > package.json
        fi
        set -e  # Exit on error for subsequent steps
        
    - name: Create report directory
      run: |
        mkdir -p $REPORT_DIR
        
    - name: Run npm audit
      run: |
        set +e  # Don't exit on error
        echo "Running npm audit..."
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        echo "=== NPM AUDIT START ==="
        npm audit --json > $REPORT_DIR/npm_audit.json 2>&1 || echo "npm audit completed with issues"
        echo "=== NPM AUDIT END ==="
        echo "npm audit output:"
        cat $REPORT_DIR/npm_audit.json || echo "No npm audit output found"
        set -e  # Exit on error for subsequent steps
        
    - name: Create sample JS files
      run: |
        cat > app.js << 'EOF'
        function add(a, b) {
          return a + b
        }

        function risky(input) {
          eval(input)
        }

        module.exports = { add, risky }
        EOF

        cat > utils.js << 'EOF'
        function add(a, b) {
          return a + b
        }
        module.exports = { add }
        EOF
        
    - name: Install scan tools
      run: |
        npm install -g eslint jscpd retire plato jsdoc
        
    - name: Create ESLint config
      run: |
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "node": true,
            "es2021": true
          },
          "extends": ["eslint:recommended"],
          "rules": {
            "no-eval": "error",
            "no-unused-vars": "error"
          }
        }
        EOF

    - name: Run ESLint
      run: |
        eslint . -f json -o $REPORT_DIR/eslint.json || true
        
    - name: Run jscpd
      run: |
        jscpd . --reporters json --output $REPORT_DIR/jscpd || true
        cp $REPORT_DIR/jscpd/jscpd-report.json $REPORT_DIR/jscpd.json || true
        
    - name: Run Retire.js
      run: |
        retire           --js           --node           --outputformat json           --outputpath $REPORT_DIR/retire.json           . || true
        
    - name: Run Plato
      run: |
        plato -r -d $REPORT_DIR/plato app.js utils.js || true
        
    - name: Run JSDoc
      run: |
        jsdoc app.js utils.js -X > $REPORT_DIR/jsdoc.json || true
        
    - name: Generate severity summary
      run: |
        python3 << 'PYEOF'
        import json
        import os
        from pathlib import Path
        
        report_dir = Path(os.environ.get('REPORT_DIR', 'scan-reports'))
        
        severity_summary = dict()
        severity_summary['critical'] = []
        severity_summary['high'] = []
        severity_summary['medium'] = []
        severity_summary['low'] = []
        severity_summary['info'] = []

        # Process ESLint results
        eslint_file = report_dir / 'eslint.json'
        if eslint_file.exists() and eslint_file.stat().st_size > 0:
            try:
                with open(eslint_file) as f:
                    eslint_data = json.load(f)
                    for result in eslint_data:
                        if result.get('errorCount', 0) > 0 or result.get('warningCount', 0) > 0:
                            for message in result.get('messages', []):
                                severity = 'high' if message.get('severity') == 2 else 'medium'
                                severity_summary[severity].append(dict(
                                    tool='eslint',
                                    file='./' + result.get('filePath', '').lstrip('./'),
                                    line=message.get('line'),
                                    column=message.get('column'),
                                    issue=message.get('ruleId'),
                                    message=message.get('message')
                                ))
            except Exception as e:
                print('Error processing eslint.json: ' + str(e))

        # Process NPM Audit results
        npm_audit_file = report_dir / 'npm_audit.json'
        if npm_audit_file.exists() and npm_audit_file.stat().st_size > 0:
            try:
                with open(npm_audit_file) as f:
                    npm_data = json.load(f)
                    vulnerabilities = npm_data.get('vulnerabilities', {})
                    for vuln_id, vuln_info in vulnerabilities.items():
                        severity_mapping = {
                            'critical': 'critical',
                            'high': 'high', 
                            'moderate': 'medium',
                            'low': 'low',
                            'info': 'info'
                        }
                        severity = severity_mapping.get(vuln_info.get('severity', 'low'), 'low')
                        
                        if severity in severity_summary:
                            severity_summary[severity].append(dict(
                                tool='npm_audit',
                                file='./package.json',
                                issue=vuln_id,
                                message=vuln_info.get('title', 'Security vulnerability'),
                                severity=vuln_info.get('severity', 'low'),
                                info=vuln_info.get('url', 'No additional info')
                            ))
            except Exception as e:
                print('Error processing npm_audit.json: ' + str(e))

        # Process Retire.js results
        retire_file = report_dir / 'retire.json'
        if retire_file.exists() and retire_file.stat().st_size > 0:
            try:
                with open(retire_file) as f:
                    retire_data = json.load(f)
                    if isinstance(retire_data, dict) and 'data' in retire_data:
                        for file_entry in retire_data['data']:
                            if isinstance(file_entry, dict):
                                file_path = file_entry.get('file', 'unknown')
                                vulnerabilities = file_entry.get('vulnerabilities', [])
                                for vuln in vulnerabilities:
                                    severity_mapping = {
                                        'critical': 'critical',
                                        'high': 'high',
                                        'medium': 'medium', 
                                        'low': 'low',
                                        'info': 'info'
                                    }
                                    severity = severity_mapping.get(vuln.get('severity', 'low'), 'low')
                                    
                                    if severity in severity_summary:
                                        severity_summary[severity].append(dict(
                                            tool='retire',
                                            file='./' + file_path.lstrip('./'),
                                            line=1,
                                            issue=vuln.get('component', 'unknown-component'),
                                            message=vuln.get('identifiers', {}).get('summary', 'Security vulnerability'),
                                            severity=vuln.get('severity', 'medium'),
                                            info=vuln.get('info', 'No additional info')
                                        ))
            except Exception as e:
                print('Error processing retire.json: ' + str(e))

        # Process Plato complexity results
        plato_report_file = report_dir / 'plato' / 'report.json'
        if plato_report_file.exists() and plato_report_file.stat().st_size > 0:
            try:
                with open(plato_report_file) as f:
                    plato_data = json.load(f)
                    reports = plato_data.get('reports', {})
                    for file_path, report_item in reports.items():
                        if isinstance(report_item, dict):
                            file_path = './' + file_path.lstrip('./')
                            maintainability = report_item.get('maintainability', 0)
                            complexity = report_item.get('complexity', {}).get('aggregate', {}).get('cyclomatic', 0)

                            if complexity > 15:
                                severity_summary['high'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,
                                    issue='high_complexity',
                                    message='Cyclomatic complexity: ' + str(complexity)
                                ))
                            elif complexity > 10:
                                severity_summary['medium'].append(dict(
                                    tool='plato',
                                    file=file_path,
                                    line=1,
                                    issue='medium_complexity',
                                    message='Cyclomatic complexity: ' + str(complexity)
                                ))
            except Exception as e:
                print('Error processing plato report.json: ' + str(e))

        # Process JSCPD results
        jscpd_file = report_dir / 'jscpd.json'
        if jscpd_file.exists() and jscpd_file.stat().st_size > 0:
            try:
                with open(jscpd_file) as f:
                    jscpd_data = json.load(f)
                    if isinstance(jscpd_data, dict) and 'duplicates' in jscpd_data:
                        for duplicate in jscpd_data['duplicates']:
                            if isinstance(duplicate, dict):
                                first_file = duplicate.get('firstFile', {}).get('name', 'unknown')
                                second_file = duplicate.get('secondFile', {}).get('name', 'unknown')
                                lines = duplicate.get('lines', 0)
                                
                                severity_summary['medium'].append(dict(
                                    tool='jscpd',
                                    file=f'{first_file} <-> {second_file}',
                                    line=1,
                                    issue='code_duplication',
                                    message=f'Duplicate code: {lines} lines'
                                ))
            except Exception as e:
                print('Error processing jscpd.json: ' + str(e))
        
        # Process JSDoc results
        jsdoc_file = report_dir / 'jsdoc.json'
        if jsdoc_file.exists() and jsdoc_file.stat().st_size > 0:
            try:
                with open(jsdoc_file) as f:
                    jsdoc_data = json.load(f)
                    
                    if isinstance(jsdoc_data, dict) and 'docs' in jsdoc_data:
                        for doc_entry in jsdoc_data['docs']:
                            if isinstance(doc_entry, dict) and doc_entry.get('undocumented', False):
                                severity_summary['info'].append(dict(
                                    tool='jsdoc',
                                    file='./' + doc_entry.get('meta', {}).get('filename', 'unknown').lstrip('./'),
                                    name=doc_entry.get('name', 'unknown'),
                                    line=doc_entry.get('meta', {}).get('lineno', 1),
                                    message='Missing JSDoc comment'
                                ))
                    else:
                        severity_summary['info'].append(dict(
                            tool='jsdoc',
                            file='./',
                            line=1,
                            issue='documentation_scan',
                            message=f'JSDoc scanned {len(jsdoc_data) if isinstance(jsdoc_data, (list, dict)) else 0} symbols'
                        ))
            except Exception as e:
                print('Error processing jsdoc.json: ' + str(e))
        
        # Save severity summary
        output_file = report_dir / 'severity_summary.json'
        with open(output_file, 'w') as f:
            json.dump(severity_summary, f, indent=2)

        print('=== FINAL SEVERITY SUMMARY ===')
        for severity, issues in severity_summary.items():
            print(str(severity) + ': ' + str(len(issues)) + ' issues')
        print('Severity summary saved to: ' + str(output_file))
        PYEOF
        
    - name: Verify scan outputs
      run: |
        ls -R $REPORT_DIR
        test -f $REPORT_DIR/eslint.json || echo "❌ eslint missing"
        test -f $REPORT_DIR/npm_audit.json || echo "❌ npm audit missing"
        test -f $REPORT_DIR/retire.json || echo "❌ retire missing"
        test -f $REPORT_DIR/jscpd.json || echo "❌ jscpd missing"
        test -f $REPORT_DIR/jsdoc.json || echo "❌ jsdoc missing"
        test -f $REPORT_DIR/plato/report.json || echo "❌ plato missing"
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: node-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
        
    - name: Generate simple report
      run: |
        set +e  # Don't exit on error
        echo "## Node.js Security Scan Results" > $GITHUB_STEP_SUMMARY
        echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- npm audit: \`$REPORT_DIR/npm_audit.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: \`$REPORT_DIR/eslint.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Completed: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Report Directory Contents" >> $GITHUB_STEP_SUMMARY
        ls -la $REPORT_DIR/ >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No reports directory found" >> $GITHUB_STEP_SUMMARY
        set -e  # Exit on error for subsequent steps

env:
  REPORT_DIR: scan-reports
