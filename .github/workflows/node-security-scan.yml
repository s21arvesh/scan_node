name: "Node.js Security Scan - Dynamic"

on:
  workflow_dispatch:

jobs:
  node-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        
    - name: Install dependencies
      run: |
        set +e  # Don't exit on error
        if [ -f "package.json" ]; then
          if [ -f "package-lock.json" ]; then
            echo "Installing from lock file..."
            npm ci --no-audit --no-fund || echo "npm ci failed, trying npm install..."
            npm install --no-audit --no-fund || echo "npm install also failed"
          else
            echo "No lock file found, running npm install..."
            npm install --no-audit --no-fund || echo "npm install failed"
          fi
        else
          echo "No package.json found, creating dummy package.json"
          echo '{"name": "test-project", "version": "1.0.0", "scripts": {}}' > package.json
        fi
        set -e  # Exit on error for subsequent steps
        
    - name: Create report directory
      run: |
        mkdir -p $REPORT_DIR
        
    - name: Run npm audit
      run: |
        set +e  # Don't exit on error
        echo "Running npm audit..."
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        echo "=== NPM AUDIT START ==="
        npm audit --json > $REPORT_DIR/npm_audit.json 2>&1 || echo "npm audit completed with issues"
        echo "=== NPM AUDIT END ==="
        echo "npm audit output:"
        cat $REPORT_DIR/npm_audit.json || echo "No npm audit output found"
        set -e  # Exit on error for subsequent steps
        
    - name: Create sample JS files
      run: |
        cat > app.js << 'EOF'
        function add(a, b) {
          return a + b
        }

        function risky(input) {
          eval(input)
        }

        let unusedVar = 42;

        console.log("This will trigger no-console warning");

        module.exports = { add, risky }
        EOF

        cat > utils.js << 'EOF'
        function add(a, b) {
          return a + b
        }

        function duplicate(a, b) {
          return a + b
        }

        let anotherUnused = "test";

        console.log("Another console log");

        module.exports = { add, duplicate }
        EOF
        
    - name: Install scan tools
      run: |
        npm install -g eslint jscpd retire plato jsdoc
        
    - name: Create ESLint config
      run: |
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "node": true,
            "es2021": true
          },
          "extends": ["eslint:recommended"],
          "rules": {
            "no-eval": "error",
            "no-unused-vars": "error",
            "no-undef": "error",
            "no-console": "warn"
          }
        }
        EOF

    - name: Run ESLint
      continue-on-error: true
      run: |
        echo "Running ESLint (non-blocking)..."
        echo "Current directory:"
        pwd
        echo "All JS files:"
        find . -name "*.js" -type f
        echo "Files excluding node_modules:"
        find . -name "*.js" -type f -not -path "./node_modules/*"
        echo "ESLint config:"
        cat .eslintrc.json
        
        echo "Running ESLint on specific files:"
        eslint app.js utils.js           -f json           -o $REPORT_DIR/eslint.json || true

        echo "ESLint output:"
        cat $REPORT_DIR/eslint.json || echo "No ESLint output file found"
        
        # Ensure file exists for artifacts
        if [ ! -f "$REPORT_DIR/eslint.json" ]; then
          echo "[]" > $REPORT_DIR/eslint.json
          echo "Created empty eslint.json for artifacts"
        fi
        
    - name: Run jscpd
      run: |
        jscpd .           --reporters json           --output $REPORT_DIR/jscpd           --min-tokens 10           --min-lines 3           --threshold 5 || true
        cp $REPORT_DIR/jscpd/jscpd-report.json $REPORT_DIR/jscpd.json || true
        
    - name: Run Retire.js
      run: |
        retire           --js           --node           --outputformat json           --outputpath $REPORT_DIR/retire.json           . || true
        
    - name: Run Plato
      run: |
        plato -r -d $REPORT_DIR/plato app.js utils.js || true
        
    - name: Run JSDoc
      run: |
        jsdoc app.js utils.js -X > $REPORT_DIR/jsdoc.json || true
        
    - name: Generate severity summary
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');

        const reportDir = process.env.REPORT_DIR || 'scan-reports';

        const summary = {
          critical: [],
          high: [],
          medium: [],
          low: [],
          info: []
        };

        // npm audit
        if (fs.existsSync(`${reportDir}/npm_audit.json`)) {
          console.log('Found npm_audit.json');
          try {
            const data = JSON.parse(fs.readFileSync(`${reportDir}/npm_audit.json`, 'utf8'));
            if (data.vulnerabilities) {
              Object.values(data.vulnerabilities).forEach(v => {
                if (v && v.severity) {
                  summary[v.severity || 'low'].push({
                    tool: 'npm_audit',
                    issue: v.name || 'unknown',
                    severity: v.severity
                  });
                }
              });
              console.log(`Processed ${Object.keys(data.vulnerabilities).length} vulnerabilities`);
            }
          } catch (e) {
            console.log('Error processing npm_audit.json:', e.message);
          }
        } else {
          console.log('npm_audit.json not found');
        }

        // eslint
        if (fs.existsSync(`${reportDir}/eslint.json`)) {
          console.log('Found eslint.json');
          try {
            const eslint = JSON.parse(fs.readFileSync(`${reportDir}/eslint.json`, 'utf8'));
            eslint.forEach(file => {
              if (file && file.messages) {
                file.messages.forEach(m => {
                  if (m && m.severity !== undefined) {
                    summary[m.severity === 2 ? 'high' : 'medium'].push({
                      tool: 'eslint',
                      file: file.filePath || 'unknown',
                      issue: m.ruleId || 'unknown',
                      message: m.message || 'no message'
                    });
                  }
                });
              }
            });
            console.log(`Processed ${eslint.length} ESLint files`);
          } catch (e) {
            console.log('Error processing eslint.json:', e.message);
          }
        } else {
          console.log('eslint.json not found');
        }

        // jscpd
        if (fs.existsSync(`${reportDir}/jscpd.json`)) {
          console.log('Found jscpd.json');
          try {
            const jscpdData = JSON.parse(fs.readFileSync(`${reportDir}/jscpd.json`, 'utf8'));
            console.log('Jscpd raw data:', JSON.stringify(jscpdData, null, 2));
            if (jscpdData.duplicates && Array.isArray(jscpdData.duplicates)) {
              console.log(`Jscpd found ${jscpdData.duplicates.length} duplicates before filtering`);
              jscpdData.duplicates.forEach((dup, index) => {
                if (dup && dup.firstFile && dup.secondFile) {
                  console.log(`Processing duplicate ${index + 1}: ${dup.firstFile.name} <-> ${dup.secondFile.name}, tokens: ${dup.tokens}, lines: ${dup.lines}`);
                  // Only add significant duplicates (more than 5 lines)
                  if (dup.lines > 5) {
                    summary['medium'].push({
                      tool: 'jscpd',
                      file: `${dup.firstFile.name} <-> ${dup.secondFile.name}`,
                      issue: 'code-duplication',
                      message: `${dup.tokens} duplicated tokens (${dup.lines} lines)`
                    });
                  } else {
                    console.log(`Skipping small duplicate: ${dup.lines} lines`);
                  }
                }
              });
              console.log(`Added ${summary['medium'].filter(item => item.tool === 'jscpd').length} significant jscpd findings`);
            }
          } catch (e) {
            console.log('Error processing jscpd.json:', e.message);
          }
        } else {
          console.log('jscpd.json not found');
        }

        // retire
        if (fs.existsSync(`${reportDir}/retire.json`)) {
          console.log('Found retire.json');
          try {
            const retireData = JSON.parse(fs.readFileSync(`${reportDir}/retire.json`, 'utf8'));
            if (retireData.data && Array.isArray(retireData.data)) {
              if (retireData.data.length === 0) {
                console.log('Retire.js: passed with no vulnerabilities');
                // No vulnerabilities found - this is a valid pass
              } else {
                retireData.data.forEach(v => {
                  if (v && v.severity) {
                    summary[v.severity || 'low'].push({
                      tool: 'retire',
                      issue: v.component || 'unknown',
                      severity: v.severity,
                      message: v.identifiers && v.identifiers.summary ? v.identifiers.summary[0] : 'vulnerability found'
                    });
                  }
                });
                console.log(`Retire.js: found ${retireData.data.length} vulnerabilities`);
              }
            }
          } catch (e) {
            console.log('Error processing retire.json:', e.message);
          }
        } else {
          console.log('retire.json not found');
        }

        // plato - artifact only (HTML report)
        if (fs.existsSync(`${reportDir}/plato/index.html`)) {
          console.log('Found Plato HTML report');
          // Plato is report-only, not included in severity summary
          // Handled as artifact: plato-report/index.html
        } else {
          console.log('Plato HTML report not found');
        }

        fs.writeFileSync(
          `${reportDir}/severity_summary.json`,
          JSON.stringify(summary, null, 2)
        );

        console.log('severity_summary.json generated');
        EOF
        
    - name: Verify summary
      run: |
        echo "=== VERIFYING SEVERITY SUMMARY ==="
        ls -la $REPORT_DIR
        echo "=== CHECKING IF severity_summary.json EXISTS ==="
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          echo "✅ severity_summary.json FOUND"
          echo "=== CONTENTS OF severity_summary.json ==="
          cat $REPORT_DIR/severity_summary.json
        else
          echo "❌ severity_summary.json MISSING"
          echo "=== ALL FILES IN REPORT DIRECTORY ==="
          find $REPORT_DIR -type f -exec echo "File: {}" \;
        fi
        
    - name: Generate simple report
      run: |
        set +e  # Don't exit on error
        echo "## Node.js Security Scan Results" > $GITHUB_STEP_SUMMARY
        echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- npm audit: \`$REPORT_DIR/npm_audit.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: \`$REPORT_DIR/eslint.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Completed: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Report Directory Contents" >> $GITHUB_STEP_SUMMARY
        ls -la $REPORT_DIR/ >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No reports directory found" >> $GITHUB_STEP_SUMMARY
        set -e  # Exit on error for subsequent steps

    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: node-scan-reports
        path: scan-reports/

env:
  REPORT_DIR: scan-reports
