
name: Dynamic JavaScript Code Scan

on:
  workflow_dispatch:
    inputs:
      scan_tools:
        description: 'Comma-separated list of tools to run'
        required: false
        default: 'eslint,plato'
      project_name:
        description: 'Project name for reporting'
        required: false
        default: 'javascript-project'

env:
  REPORT_DIR: scan-reports

jobs:
  javascript-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: Install scanning tools
      run: |
        npm install -g eslint npm-audit-ci retire plato
        
    - name: Create report directory
      run: mkdir -p $REPORT_DIR
      
    - name: Run JavaScript code scans
      run: |
        echo 'Starting JavaScript security scan...'
        echo 'Current directory contents:'
        ls -la
        echo 'Looking for package.json:'
        if [ -f "package.json" ]; then
          echo 'package.json found:'
          cat package.json
        else
          echo 'No package.json found - creating dummy one for testing'
          echo '{"name": "test-project", "version": "1.0.0"}' > package.json
        fi
        echo 'Creating ESLint configuration...'
        echo 'module.exports = { env: { browser: true, es2021: true, node: true }, extends: ["eslint:recommended"], parserOptions: { ecmaVersion: 12, sourceType: "commonjs" }, rules: { "no-var": "error", "semi": "error", "no-unused-vars": "warn", "eqeqeq": "error", "no-alert": "error", "one-var": "error", "no-extra-parens": "warn", "quotes": ["error", "double"], "no-undef": "error" } };' > eslint.config.js
        echo 'JavaScript files found:'
        find . -name "*.js" -type f | head -10
        echo '=== Running Scan Commands ==='
        echo 'Running ESLint...'\n        eslint . --format=json --output-file=$REPORT_DIR/eslint.json || true\n        echo 'Running Plato Complexity Analysis...'\n        plato -r -d $REPORT_DIR/plato-report . 2>/dev/null || (mkdir -p $REPORT_DIR/plato-report && echo '{"reports": {}}' > $REPORT_DIR/plato-report/index.json)
        echo '=== Scan Commands Completed ==='
        echo 'Report directory contents after scans:'
        ls -la $REPORT_DIR/
        
    - name: Generate severity summary
      run: |
        node << 'SCRIPT_EOF'
        const fs = require('fs');
        const path = require('path');

        const reportDir = process.env.REPORT_DIR || 'scan-reports';
        let severitySummary = {
            "critical": [],
            "high": [],
            "medium": [],
            "low": [],
            "info": []
        };
        
        console.log('=== DEBUG: JavaScript Severity Summary Generation ===');
        console.log('Report directory:', reportDir);
        console.log('Files in report directory:');
        try {
            const files = fs.readdirSync(reportDir);
            console.log(files);
        } catch (e) {
            console.log('Error reading directory:', e);
        }
        
        // Process ESLint results
        console.log('=== DEBUG: Checking eslint.json ===');
        if (fs.existsSync(`${reportDir}/eslint.json`)) {
            console.log('eslint.json found, processing...');
            try {
                const eslintData = JSON.parse(fs.readFileSync(`${reportDir}/eslint.json`, 'utf8'));
                console.log('ESLint data:', eslintData);
                console.log('ESLint results count:', eslintData.length);
                eslintData.forEach(result => {
                    // Only add files that have actual issues
                    if (result.errorCount > 0 || result.warningCount > 0) {
                        result.messages.forEach(message => {
                            const severity = message.severity ? (message.severity === 2 ? 'high' : 'medium') : 'medium';
                            if (severitySummary[severity]) {
                                severitySummary[severity].push({
                                    'tool': 'eslint',
                                    'file': result.filePath,
                                    'line': message.line || 'N/A',
                                    'column': message.column || 'N/A',
                                    'issue': message.ruleId || 'eslint-rule',
                                    'message': message.message
                                });
                            }
                        });
                    }
                });
            } catch (e) {
                console.log('Error processing eslint.json: ' + e);
            }
        } else {
            console.log('ESLint file does NOT exist');
        }
        
        // Process npm_audit results
        if (fs.existsSync(reportDir + '/npm_audit.json')) {
            try {
                const npmData = JSON.parse(fs.readFileSync(reportDir + '/npm_audit.json', 'utf8'));
                if (npmData.vulnerabilities && npmData.vulnerabilities.length > 0) {
                    npmData.vulnerabilities.forEach(vuln => {
                        const severity = vuln.severity ? vuln.severity.toLowerCase() : 'unknown';
                        if (severitySummary[severity]) {
                            severitySummary[severity].push({
                                'tool': 'npm_audit',
                                'package': vuln.module_name,
                                'version': (vuln.findings && vuln.findings.length > 0) ? vuln.findings[0].version : 'N/A',
                                'issue': vuln.title,
                                'message': vuln.overview || 'Vulnerability found'
                            });
                        }
                    });
                }
            } catch (e) {
                console.log('Error processing npm_audit.json: ' + e);
            }
        }
        
        // Process Retire.js results
        if (fs.existsSync(reportDir + '/retire.json')) {
            try {
                const retireData = JSON.parse(fs.readFileSync(reportDir + '/retire.json', 'utf8'));
                if (retireData.data && retireData.data.length > 0) {
                    retireData.data.forEach(vuln => {
                        if (vuln.severity === 'high' || vuln.severity === 'critical') {
                            severitySummary[vuln.severity].push({
                                'tool': 'retire',
                                'package': vuln.component,
                                'version': vuln.version,
                                'issue': vuln.identifiers.join(', '),
                                'message': vuln.info.join(', ')
                            });
                        } else if (vuln.severity === 'medium') {
                            severitySummary.medium.push({
                                'tool': 'retire',
                                'package': vuln.component,
                                'version': vuln.version,
                                'issue': vuln.identifiers.join(', '),
                                'message': vuln.info.join(', ')
                            });
                        }
                    });
                }
            } catch (e) {
                console.log('Error processing retire.json: ' + e);
            }
        }

        // Process Plato results
        if (fs.existsSync(`${reportDir}/plato-report/index.json`)) {
            try {
                const platoData = JSON.parse(fs.readFileSync(`${reportDir}/plato-report/index.json`, 'utf8'));
                Object.keys(platoData.reports).forEach(file => {
                    const report = platoData.reports[file];
                    if (report.complexity && report.complexity.aggregate.complexity.cyclomatic > 10) {
                        severitySummary.medium.push({
                            'tool': 'plato',
                            'file': file,
                            'issue': 'High complexity',
                            'message': `Cyclomatic complexity: ${report.complexity.aggregate.complexity.cyclomatic}`
                        });
                    }
                });
            } catch (e) {
                console.log(`Error processing plato report: ${e}`);
            }
        }

        // Save severity summary
        console.log('=== DEBUG: Final Severity Summary ===');
        console.log('Critical:', severitySummary.critical.length);
        console.log('High:', severitySummary.high.length);
        console.log('Medium:', severitySummary.medium.length);
        console.log('Low:', severitySummary.low.length);
        console.log('Info:', severitySummary.info.length);
        console.log('Final summary:', JSON.stringify(severitySummary, null, 2));
        
        fs.writeFileSync(reportDir + '/severity_summary.json', JSON.stringify(severitySummary, null, 2));
        console.log("JavaScript severity summary generated successfully");
        SCRIPT_EOF
        
    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javascript-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 30
        
    - name: Generate scan summary
      run: |
        echo "## JavaScript Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "### Severity Summary" >> $GITHUB_STEP_SUMMARY
        echo "'json'" >> $GITHUB_STEP_SUMMARY
        cat $REPORT_DIR/severity_summary.json >> $GITHUB_STEP_SUMMARY
        echo "'json'" >> $GITHUB_STEP_SUMMARY
        
        echo "### Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "- npm-audit: 'npm_audit.json'" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: 'eslint.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Plato: 'plato.json'" >> $GITHUB_STEP_SUMMARY
        echo "- JSDoc: 'jsdoc'" >> $GITHUB_STEP_SUMMARY
        echo "- JSCPD: 'jscpd.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Retire.js: 'retire.json'" >> $GITHUB_STEP_SUMMARY
        echo "- Severity Summary: 'severity_summary.json'" >> $GITHUB_STEP_SUMMARY
        
        echo "### Repository Information" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        
        echo "### Timestamp" >> $GITHUB_STEP_SUMMARY
        echo "- Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Send results to API
      if: always()
      run: |
        if [ -f "$REPORT_DIR/severity_summary.json" ]; then
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @- \
            "https://eop7f15rcm9dnz.m.pipedream.net" << EOF
        {
          "repository": "${{ github.repository }}",
          "branch": "${{ github.ref_name }}",
          "run_id": "${{ github.run_id }}",
          "severity_results": $(cat $REPORT_DIR/severity_summary.json),
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        fi
      shell: bash
