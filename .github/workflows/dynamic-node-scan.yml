name: "Node.js Security Scan"

on:
  workflow_dispatch:

jobs:
  node-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        
    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          if [ -f "package-lock.json" ]; then
            echo "Installing from lock file..."
            npm ci --no-audit --no-fund
          else
            echo "No lock file found, running npm install..."
            npm install --no-audit --no-fund
          fi
        else
          echo "No package.json found, creating dummy package.json"
          echo '{"name": "test-project", "version": "1.0.0", "scripts": {}}' > package.json
        fi
        
    - name: Create report directory
      run: |
        mkdir -p $REPORT_DIR
        
    - name: Run npm audit
      run: |
        echo "Running npm audit..."
        npm audit --json > $REPORT_DIR/npm_audit.json || echo "npm audit completed with issues"
        
    - name: Run ESLint
      run: |
        echo "Running ESLint..."
        npm install -g eslint
        echo 'module.exports = [];' > eslint.config.js
        eslint . -f json -o $REPORT_DIR/eslint.json || echo "ESLint completed"
        
    - name: Generate simple report
      run: |
        echo "## Node.js Security Scan Results" > $GITHUB_STEP_SUMMARY
        echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- npm audit: \`$REPORT_DIR/npm_audit.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: \`$REPORT_DIR/eslint.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Completed: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

    - name: Upload scan reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: node-scan-reports
        path: ${{ env.REPORT_DIR }}/
        retention-days: 7

env:
  REPORT_DIR: scan-reports
